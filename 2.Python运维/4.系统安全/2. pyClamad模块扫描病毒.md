# 2. `pyClamad` 模块扫描病毒

## 2.1 `ClamAV` 与 `pyClamad`
`Clam AntiVirus`(`ClamAV`)是一款 免费而且开放源代码 的防毒软件，软件与病毒库的更新皆由社区免费发布
* 官网地址: http://www.clamav.net/lang/en/

目前ClamAV主要为Linux、Unix系统提供病毒扫描、查杀等服务。

`pyClamad`是一个Python第三方模块，可让Python直接使用ClamAV病毒扫描守护进程clamd，来实现一个高效的病毒检测功能。

* 官网地址: http://xael.org/norman/python/pyclamd/

另外，`pyClamad` 模块也非常容易整合到我们已有的平台当中。


### 下载 `pyclamd`

#### 客户端(病毒扫描源)安装步骤

```shell
yum install -y clamav clamd clamav-update #安装clamavp相关程序包

chkconfig --levels 235 clamd on #添加扫描守护进程clamd系统服务

/usr/bin/freshclam #更新病毒库，建议配置到crontab中定期更新

setenforce 0 #关闭SELinux，避免远程扫描时提示无权限的问题

# 更新守护进程监听IP配置文件，根据不同环境自行修改监听的IP，“0.0.0.0”为监听所有主机IP

sed -i -e '/^TCPAddr/{ s/127.0.0.1/0.0.0.0/； }' /etc/clamd.conf

/etc/init.d/clamd start #启动扫描守护进程
```

#### 主控端部署 `pyClamad` 环境步骤
* Mac OS 安装:
```shell
pip3 install pyclamd
```
* CentOS 7安装:
```shell
pip3 install pyclamd
```

* 下载源码安装
```shell
wget http://xael.org/norman/python/pyclamd/pyClamd-0.3.4.tar.gz

tar -zxvf pyClamd-0.3.4.tar.gz

cd pyClamd-0.3.4

python setup.py install
```

## 4.2 `pyClamad` 常用方法
`pyClamad` 提供了2个关键类:
* `ClamdNetworkSocket()`类: 实现使用网络套接字操作 clamd
* `ClamdUnixSocket()`类: 实现使用Unix套接字类操作 clamd
  
> `说明`: 两个类定义的方法完全一样，本节以 `ClamdNetworkSocket()` 类进行说明。

### `ClamdNetworkSocket()`类

#### `__init__`: 初始化方法
`ClamdNetworkSocket` 类的初始化方法:
```python
__init__(self, host='127.0.0.1', port=3310, timeout=None)
```

参数说明:
* `host`: 连接主机IP
* `port`: 连接的端口，默认为3310，与/etc/clamd.conf配置文件中的TCPSocket参数要保持一致
* `timeout`: 连接的超时时间

#### `contscan_file`: 扫描指定文件、目录

实现扫描指定的文件或目录，在扫描时发生错误或发现病毒将不终止。

```python
contscan_file(self, file)
```
参数说明:
* `file`: string类型，为指定的文件或目录的绝对路径。

#### `multiscan_file`: 多线程扫描指定的文件或目录
实现多线程扫描指定的文件或目录，多核环境速度更快，在扫描时发生错误或发现病毒将不终止。
```python
multiscan_file(self, file)
```
参数说明:
* `file`: string类型，为指定的文件或目录的绝对路径。

#### `scan_file`: 扫描指定的文件或目录
实现扫描指定的文件或目录，在扫描时发生错误或发现病毒将终止。
```python
scan_file(self, file)
```

参数说明:
* `file`: string类型，为指定的文件或目录的绝对路径。

#### `shutdown`: 强制关闭clamd进程并退出

```python
shutdown(self)
```

#### `stats`: 获取Clamscan的当前状态

```python
stats(self)
```

#### `reload`: 重载clamd病毒特征库
强制重载clamd病毒特征库。

`注意`: 扫描前建议做reload操作。
```python
reload(self)
```

#### `EICAR`: 返回EICAR测试字符串
即生成具有病毒特征的字符串，便于测试。
```python
EICAR(self)
```

